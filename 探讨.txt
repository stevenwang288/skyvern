// ========================= æ‰©å±•Skyvernæµè§ˆå™¨é›†æˆæ–¹æ¡ˆ =========================
 è¿™æ˜¯å¤§æ¨¡å‹   https://apis.iflow.cn/v1	sk-2c42e76b6de37e5463bfc72d04812f8f	qwen3-vl-plus
D:\OneDrive\steven\code\1\ads2\local-api-mcp-typescript-main
// ===== 1. åç«¯Schemaæ‰©å±• (skyvern/forge/sdk/schemas/browser.py) =====
from enum import StrEnum
from pydantic import BaseModel, Field
from typing import Optional, List, Dict, Any
 
class BrowserType(StrEnum):
    """
    æµè§ˆå™¨ç±»å‹æšä¸¾
    - skyvern_default: Skyverné»˜è®¤æµè§ˆå™¨ï¼Œä½¿ç”¨ç°æœ‰çš„chromium-headless/headfulæ¨¡å¼
    - local_custom: æœ¬åœ°è‡ªå®šä¹‰Chromeï¼Œå…è®¸ç”¨æˆ·æŒ‡å®šChromeè·¯å¾„å’Œå‚æ•°
    - adspower: AdsPoweré˜²å…³è”æµè§ˆå™¨ï¼Œä¼ä¸šçº§åæ£€æµ‹è§£å†³æ–¹æ¡ˆ
    """
    SKYVERN_DEFAULT = "skyvern_default"
    LOCAL_CUSTOM = "local_custom" 
    ADSPOWER = "adspower"
 
class BrowserConfig(BaseModel):
    """
    æµè§ˆå™¨é…ç½®æ¨¡å‹ï¼Œæ”¯æŒå¤šç§æµè§ˆå™¨ç±»å‹çš„ç»Ÿä¸€é…ç½®
    """
    type: BrowserType = Field(
        default=BrowserType.SKYVERN_DEFAULT,
        description="æµè§ˆå™¨ç±»å‹ï¼Œå†³å®šä½¿ç”¨å“ªç§æµè§ˆå™¨åˆ›å»ºç­–ç•¥"
    )
    chrome_path: Optional[str] = Field(
        default=None,
        description="æœ¬åœ°Chromeæ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œä»…åœ¨typeä¸ºlocal_customæ—¶ä½¿ç”¨"
    )
    chrome_args: Optional[List[str]] = Field(
        default=None,
        description="Chromeå¯åŠ¨å‚æ•°åˆ—è¡¨ï¼Œå¯ç”¨äºè‡ªå®šä¹‰æµè§ˆå™¨è¡Œä¸º"
    )
    adspower_user_id: Optional[str] = Field(
        default=None,
        description="AdsPoweræµè§ˆå™¨ç”¨æˆ·IDï¼Œä»…åœ¨typeä¸ºadspoweræ—¶ä½¿ç”¨"
    )
    adspower_group_id: Optional[str] = Field(
        default=None,
        description="AdsPoweræµè§ˆå™¨åˆ†ç»„IDï¼Œå¯é€‰"
    )
 
class AdsPowerBrowserInfo(BaseModel):
    """AdsPoweræµè§ˆå™¨ä¿¡æ¯æ¨¡å‹"""
    user_id: str = Field(description="æµè§ˆå™¨ç”¨æˆ·ID")
    name: str = Field(description="æµè§ˆå™¨åç§°")
    serial_number: str = Field(description="æµè§ˆå™¨åºåˆ—å·")
    remark: Optional[str] = Field(default=None, description="å¤‡æ³¨ä¿¡æ¯")
    group_id: Optional[str] = Field(default=None, description="åˆ†ç»„ID")
    status: str = Field(description="æµè§ˆå™¨çŠ¶æ€ï¼šActive/Inactive")
 
class AdsPowerStatus(BaseModel):
    """AdsPoweræœåŠ¡çŠ¶æ€æ¨¡å‹"""
    available: bool = Field(description="AdsPoweræœåŠ¡æ˜¯å¦å¯ç”¨")
    message: str = Field(description="çŠ¶æ€ä¿¡æ¯")
    browsers: List[AdsPowerBrowserInfo] = Field(default=[], description="å¯ç”¨æµè§ˆå™¨åˆ—è¡¨")
 
# ===== 2. ä»»åŠ¡Schemaæ‰©å±• (ä¿®æ”¹ skyvern/forge/sdk/schemas/tasks.py) =====
# åœ¨TaskBaseç±»ä¸­æ·»åŠ browser_configå­—æ®µï¼š
 
class TaskBase(BaseModel):
    # ... ç°æœ‰å­—æ®µä¿æŒä¸å˜ ...
    
    browser_config: Optional[BrowserConfig] = Field(
        default=None,
        description="æµè§ˆå™¨é…ç½®ï¼ŒæŒ‡å®šä»»åŠ¡ä½¿ç”¨çš„æµè§ˆå™¨ç±»å‹å’Œç›¸å…³å‚æ•°"
    )
 
# ===== 3. æµè§ˆå™¨å·¥å‚æ‰©å±• (ä¿®æ”¹ skyvern/webeye/browser_factory.py) =====
import asyncio
import aiohttp
import subprocess
import tempfile
import random
import structlog
from pathlib import Path
from typing import Dict, Any, Tuple, Optional
from playwright.async_api import Playwright, BrowserContext, Page
from skyvern.forge.sdk.schemas.browser import BrowserConfig, BrowserType, AdsPowerStatus
 
LOG = structlog.get_logger()
 
class AdsPowerService:
    """
    AdsPower APIæœåŠ¡ç±»ï¼Œè´Ÿè´£ä¸AdsPowerå®¢æˆ·ç«¯è¿›è¡Œäº¤äº’
    æä¾›æµè§ˆå™¨çŠ¶æ€æ£€æŸ¥ã€å¯åŠ¨ã€åœæ­¢ç­‰åŠŸèƒ½
    """
    
    def __init__(self, base_url: str = "http://localhost:50325"):
        self.base_url = base_url
        self.timeout = 30
        
    async def check_status(self) -> AdsPowerStatus:
        """
        æ£€æŸ¥AdsPoweræœåŠ¡çŠ¶æ€å¹¶è·å–å¯ç”¨æµè§ˆå™¨åˆ—è¡¨
        
        Returns:
            AdsPowerStatus: åŒ…å«æœåŠ¡çŠ¶æ€å’Œæµè§ˆå™¨åˆ—è¡¨çš„å¯¹è±¡
        """
        try:
            # æ£€æŸ¥AdsPoweræœåŠ¡æ˜¯å¦è¿è¡Œ
            async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=5)) as session:
                async with session.get(f"{self.base_url}/api/v1/status") as resp:
                    if resp.status != 200:
                        return AdsPowerStatus(
                            available=False,
                            message=f"AdsPoweræœåŠ¡å“åº”å¼‚å¸¸: HTTP {resp.status}",
                            browsers=[]
                        )
                        
                # è·å–æµè§ˆå™¨åˆ—è¡¨
                async with session.get(f"{self.base_url}/api/v1/user/list") as resp:
                    browsers_data = await resp.json()
                    
                    if browsers_data.get("code") != 0:
                        return AdsPowerStatus(
                            available=True,
                            message="AdsPowerè¿æ¥æ­£å¸¸ï¼Œä½†è·å–æµè§ˆå™¨åˆ—è¡¨å¤±è´¥",
                            browsers=[]
                        )
                    
                    # è½¬æ¢æµè§ˆå™¨æ•°æ®æ ¼å¼
                    browsers = []
                    for browser_data in browsers_data.get("data", {}).get("list", []):
                        browsers.append(AdsPowerBrowserInfo(
                            user_id=browser_data.get("user_id", ""),
                            name=browser_data.get("name", ""),
                            serial_number=browser_data.get("serial_number", ""),
                            remark=browser_data.get("remark"),
                            group_id=browser_data.get("group_id"),
                            status=browser_data.get("status", "Unknown")
                        ))
                    
                    return AdsPowerStatus(
                        available=True,
                        message=f"AdsPowerè¿æ¥æ­£å¸¸ï¼Œæ‰¾åˆ° {len(browsers)} ä¸ªæµè§ˆå™¨",
                        browsers=browsers
                    )
                    
        except asyncio.TimeoutError:
            return AdsPowerStatus(
                available=False,
                message="AdsPowerè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯åŠ¨",
                browsers=[]
            )
        except Exception as e:
            LOG.error("æ£€æŸ¥AdsPowerçŠ¶æ€å¤±è´¥", error=str(e))
            return AdsPowerStatus(
                available=False,
                message=f"AdsPowerå®¢æˆ·ç«¯æœªå¯åŠ¨æˆ–ç½‘ç»œå¼‚å¸¸: {str(e)}",
                browsers=[]
            )
    
    async def start_browser(self, user_id: str) -> Dict[str, Any]:
        """
        å¯åŠ¨æŒ‡å®šçš„AdsPoweræµè§ˆå™¨
        
        Args:
            user_id: AdsPoweræµè§ˆå™¨ç”¨æˆ·ID
            
        Returns:
            DictåŒ…å«å¯åŠ¨ç»“æœå’Œè¿æ¥ä¿¡æ¯
        """
        try:
            async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=self.timeout)) as session:
                params = {"userId": user_id}
                async with session.get(f"{self.base_url}/api/v1/browser/start", params=params) as resp:
                    result = await resp.json()
                    
                    if result.get("code") != 0:
                        raise Exception(f"AdsPowerå¯åŠ¨æµè§ˆå™¨å¤±è´¥: {result.get('msg', 'æœªçŸ¥é”™è¯¯')}")
                    
                    # è¿”å›è¿æ¥ä¿¡æ¯
                    ws_data = result.get("data", {}).get("ws", {})
                    return {
                        "success": True,
                        "selenium_url": f"http://{ws_data.get('selenium', '')}",
                        "puppeteer_url": f"ws://{ws_data.get('puppeteer', '')}",
                        "user_id": user_id
                    }
                    
        except Exception as e:
            LOG.error("å¯åŠ¨AdsPoweræµè§ˆå™¨å¤±è´¥", user_id=user_id, error=str(e))
            raise Exception(f"å¯åŠ¨AdsPoweræµè§ˆå™¨å¤±è´¥: {str(e)}")
    
    async def stop_browser(self, user_id: str) -> bool:
        """
        åœæ­¢æŒ‡å®šçš„AdsPoweræµè§ˆå™¨
        
        Args:
            user_id: AdsPoweræµè§ˆå™¨ç”¨æˆ·ID
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸåœæ­¢
        """
        try:
            async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=10)) as session:
                params = {"userId": user_id}
                async with session.get(f"{self.base_url}/api/v1/browser/stop", params=params) as resp:
                    result = await resp.json()
                    return result.get("code") == 0
        except Exception as e:
            LOG.error("åœæ­¢AdsPoweræµè§ˆå™¨å¤±è´¥", user_id=user_id, error=str(e))
            return False
 
async def _create_adspower_browser(
    playwright: Playwright,
    proxy_location: ProxyLocation | None = None,
    extra_http_headers: dict[str, str] | None = None,
    **kwargs: dict,
) -> tuple[BrowserContext, BrowserArtifacts, BrowserCleanupFunc]:
    """
    åˆ›å»ºAdsPoweré˜²å…³è”æµè§ˆå™¨å®ä¾‹
    
    è¿™ä¸ªå‡½æ•°é›†æˆAdsPower APIï¼Œå¯åŠ¨æŒ‡å®šçš„é˜²å…³è”æµè§ˆå™¨ï¼Œå¹¶å»ºç«‹CDPè¿æ¥
    æ”¯æŒä»£ç†è®¾ç½®å’Œè‡ªå®šä¹‰HTTPå¤´
    
    Args:
        playwright: Playwrightå®ä¾‹
        proxy_location: ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰
        extra_http_headers: é¢å¤–çš„HTTPå¤´ï¼ˆå¯é€‰ï¼‰
        **kwargs: å…¶ä»–é…ç½®å‚æ•°ï¼ŒåŒ…æ‹¬browser_config
        
    Returns:
        tuple: (BrowserContext, BrowserArtifacts, cleanup_function)
    """
    browser_config: BrowserConfig = kwargs.get("browser_config")
    if not browser_config or not browser_config.adspower_user_id:
        raise ValueError("AdsPoweræ¨¡å¼éœ€è¦æä¾›æœ‰æ•ˆçš„browser_config.adspower_user_id")
    
    adspower_service = AdsPowerService()
    
    # æ£€æŸ¥AdsPoweræœåŠ¡çŠ¶æ€
    status = await adspower_service.check_status()
    if not status.available:
        raise Exception(f"AdsPowerä¸å¯ç”¨: {status.message}")
    
    LOG.info("å¯åŠ¨AdsPoweræµè§ˆå™¨", user_id=browser_config.adspower_user_id)
    
    try:
        # å¯åŠ¨AdsPoweræµè§ˆå™¨
        start_result = await adspower_service.start_browser(browser_config.adspower_user_id)
        selenium_url = start_result["selenium_url"]
        
        # ç­‰å¾…æµè§ˆå™¨å®Œå…¨å¯åŠ¨
        await asyncio.sleep(3)
        
        # å»ºç«‹CDPè¿æ¥
        browser = await playwright.chromium.connect_over_cdp(selenium_url)
        
        # è·å–æˆ–åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡
        contexts = browser.contexts
        if contexts:
            browser_context = contexts[0]
        else:
            browser_context = await browser.new_context(
                proxy=setup_proxy() if proxy_location else None,
                extra_http_headers=extra_http_headers,
            )
        
        # è®¾ç½®æµè§ˆå™¨artifacts
        browser_artifacts = BrowserContextFactory.build_browser_artifacts(**kwargs)
        
        # è®¾ç½®æ§åˆ¶å°æ—¥å¿—è®°å½•
        set_browser_console_log(browser_context, browser_artifacts)
        
        # è®¾ç½®ä¸‹è½½ç›‘å¬å™¨
        set_download_file_listener(browser_context, **kwargs)
        
        # å®šä¹‰æ¸…ç†å‡½æ•°
        def cleanup_func():
            """æ¸…ç†AdsPoweræµè§ˆå™¨èµ„æº"""
            try:
                # å¼‚æ­¥åœæ­¢AdsPoweræµè§ˆå™¨
                asyncio.create_task(adspower_service.stop_browser(browser_config.adspower_user_id))
                LOG.info("AdsPoweræµè§ˆå™¨æ¸…ç†å®Œæˆ", user_id=browser_config.adspower_user_id)
            except Exception as e:
                LOG.error("AdsPoweræµè§ˆå™¨æ¸…ç†å¤±è´¥", user_id=browser_config.adspower_user_id, error=str(e))
        
        LOG.info("AdsPoweræµè§ˆå™¨åˆ›å»ºæˆåŠŸ", user_id=browser_config.adspower_user_id, selenium_url=selenium_url)
        return browser_context, browser_artifacts, cleanup_func
        
    except Exception as e:
        LOG.error("åˆ›å»ºAdsPoweræµè§ˆå™¨å¤±è´¥", user_id=browser_config.adspower_user_id, error=str(e))
        # ç¡®ä¿å‡ºé”™æ—¶åœæ­¢æµè§ˆå™¨
        await adspower_service.stop_browser(browser_config.adspower_user_id)
        raise
 
async def _create_local_custom_browser(
    playwright: Playwright,
    proxy_location: ProxyLocation | None = None,
    extra_http_headers: dict[str, str] | None = None,
    **kwargs: dict,
) -> tuple[BrowserContext, BrowserArtifacts, BrowserCleanupFunc]:
    """
    åˆ›å»ºæœ¬åœ°è‡ªå®šä¹‰Chromeæµè§ˆå™¨å®ä¾‹
    
    å…è®¸ç”¨æˆ·æŒ‡å®šChromeè·¯å¾„å’Œå¯åŠ¨å‚æ•°ï¼Œé€‚åˆéœ€è¦ç‰¹å®šChromeç‰ˆæœ¬æˆ–é…ç½®çš„åœºæ™¯
    
    Args:
        playwright: Playwrightå®ä¾‹
        proxy_location: ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰
        extra_http_headers: é¢å¤–çš„HTTPå¤´ï¼ˆå¯é€‰ï¼‰
        **kwargs: å…¶ä»–é…ç½®å‚æ•°ï¼ŒåŒ…æ‹¬browser_config
        
    Returns:
        tuple: (BrowserContext, BrowserArtifacts, cleanup_function)
    """
    browser_config: BrowserConfig = kwargs.get("browser_config")
    if not browser_config or not browser_config.chrome_path:
        raise ValueError("æœ¬åœ°è‡ªå®šä¹‰Chromeæ¨¡å¼éœ€è¦æä¾›æœ‰æ•ˆçš„browser_config.chrome_path")
    
    chrome_path = Path(browser_config.chrome_path)
    if not chrome_path.exists():
        raise FileNotFoundError(f"Chromeè·¯å¾„ä¸å­˜åœ¨: {chrome_path}")
    
    # ç”ŸæˆéšæœºCDPç«¯å£ï¼Œé¿å…å†²çª
    cdp_port = random.randint(9222, 9999)
    while _is_port_in_use(cdp_port):
        cdp_port = random.randint(9222, 9999)
    
    # åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ•°æ®ç›®å½•
    temp_dir = tempfile.mkdtemp(prefix="skyvern_custom_chrome_")
    
    # æ„å»ºChromeå¯åŠ¨å‚æ•°
    chrome_args = [
        f"--remote-debugging-port={cdp_port}",
        f"--user-data-dir={temp_dir}",
        "--disable-blink-features=AutomationControlled",  # åè‡ªåŠ¨åŒ–æ£€æµ‹
        "--disable-web-security",  # ç¦ç”¨ç½‘ç»œå®‰å…¨æ£€æŸ¥
        "--no-first-run",  # è·³è¿‡é¦–æ¬¡è¿è¡Œ
        "--no-default-browser-check",  # è·³è¿‡é»˜è®¤æµè§ˆå™¨æ£€æŸ¥
        "--disable-infobars",  # ç¦ç”¨ä¿¡æ¯æ 
        "--disable-extensions",  # ç¦ç”¨æ‰©å±•
        "--disable-dev-shm-usage",  # ç¦ç”¨/dev/shmä½¿ç”¨
        "--no-sandbox",  # ç¦ç”¨æ²™ç®±æ¨¡å¼ï¼ˆæ³¨æ„å®‰å…¨æ€§ï¼‰
    ]
    
    # æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°
    if browser_config.chrome_args:
        chrome_args.extend(browser_config.chrome_args)
    
    # æ·»åŠ ä»£ç†è®¾ç½®
    if proxy_location:
        proxy_config = setup_proxy()
        if proxy_config and proxy_config.get("server"):
            chrome_args.append(f"--proxy-server={proxy_config['server']}")
    
    LOG.info("å¯åŠ¨æœ¬åœ°Chromeæµè§ˆå™¨", 
             chrome_path=str(chrome_path), 
             cdp_port=cdp_port, 
             temp_dir=temp_dir)
    
    try:
        # å¯åŠ¨Chromeè¿›ç¨‹
        process = subprocess.Popen(
            [str(chrome_path)] + chrome_args,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            # åœ¨Windowsä¸Šéœ€è¦CREATE_NEW_PROCESS_GROUP
            creationflags=subprocess.CREATE_NEW_PROCESS_GROUP if hasattr(subprocess, 'CREATE_NEW_PROCESS_GROUP') else 0
        )
        
        cdp_url = f"http://localhost:{cdp_port}"
        
        # ç­‰å¾…Chromeå¯åŠ¨å®Œæˆ
        if not await _wait_for_chrome_ready(cdp_url, timeout=30):
            process.terminate()
            raise Exception(f"Chromeå¯åŠ¨è¶…æ—¶ï¼ŒCDPç«¯å£: {cdp_port}")
        
        # å»ºç«‹CDPè¿æ¥
        browser = await playwright.chromium.connect_over_cdp(cdp_url)
        
        # åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡
        browser_context = await browser.new_context(
            extra_http_headers=extra_http_headers,
        )
        
        # è®¾ç½®æµè§ˆå™¨artifacts
        browser_artifacts = BrowserContextFactory.build_browser_artifacts(**kwargs)
        
        # è®¾ç½®æ§åˆ¶å°æ—¥å¿—è®°å½•
        set_browser_console_log(browser_context, browser_artifacts)
        
        # è®¾ç½®ä¸‹è½½ç›‘å¬å™¨
        set_download_file_listener(browser_context, **kwargs)
        
        # å®šä¹‰æ¸…ç†å‡½æ•°
        def cleanup_func():
            """æ¸…ç†æœ¬åœ°Chromeæµè§ˆå™¨èµ„æº"""
            try:
                # ç»ˆæ­¢Chromeè¿›ç¨‹
                if process and process.poll() is None:
                    process.terminate()
                    # ç­‰å¾…è¿›ç¨‹ç»“æŸï¼Œæœ€å¤šç­‰å¾…5ç§’
                    try:
                        process.wait(timeout=5)
                    except subprocess.TimeoutExpired:
                        process.kill()  # å¼ºåˆ¶æ€æ­»è¿›ç¨‹
                
                # æ¸…ç†ä¸´æ—¶ç›®å½•
                import shutil
                shutil.rmtree(temp_dir, ignore_errors=True)
                
                LOG.info("æœ¬åœ°Chromeæµè§ˆå™¨æ¸…ç†å®Œæˆ", cdp_port=cdp_port, temp_dir=temp_dir)
            except Exception as e:
                LOG.error("æœ¬åœ°Chromeæµè§ˆå™¨æ¸…ç†å¤±è´¥", error=str(e))
        
        LOG.info("æœ¬åœ°Chromeæµè§ˆå™¨åˆ›å»ºæˆåŠŸ", cdp_port=cdp_port, cdp_url=cdp_url)
        return browser_context, browser_artifacts, cleanup_func
        
    except Exception as e:
        LOG.error("åˆ›å»ºæœ¬åœ°Chromeæµè§ˆå™¨å¤±è´¥", error=str(e))
        # ç¡®ä¿å‡ºé”™æ—¶æ¸…ç†èµ„æº
        if 'process' in locals() and process.poll() is None:
            process.terminate()
        if 'temp_dir' in locals():
            import shutil
            shutil.rmtree(temp_dir, ignore_errors=True)
        raise
 
async def _wait_for_chrome_ready(cdp_url: str, timeout: int = 30) -> bool:
    """
    ç­‰å¾…Chromeæµè§ˆå™¨CDPæ¥å£å°±ç»ª
    
    Args:
        cdp_url: CDPè¿æ¥URL
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        
    Returns:
        bool: æ˜¯å¦æˆåŠŸè¿æ¥
    """
    for i in range(timeout):
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(f"{cdp_url}/json/version", timeout=aiohttp.ClientTimeout(total=2)) as resp:
                    if resp.status == 200:
                        LOG.debug("Chrome CDPæ¥å£å°±ç»ª", cdp_url=cdp_url, attempts=i+1)
                        return True
        except Exception:
            pass
        
        await asyncio.sleep(1)
    
    LOG.error("Chrome CDPæ¥å£è¿æ¥è¶…æ—¶", cdp_url=cdp_url, timeout=timeout)
    return False
 
# æ³¨å†Œæ–°çš„æµè§ˆå™¨ç±»å‹åˆ°å·¥å‚
BrowserContextFactory.register_type("adspower", _create_adspower_browser)
BrowserContextFactory.register_type("local-custom", _create_local_custom_browser)
 
# ===== 4. æµè§ˆå™¨ç®¡ç†å™¨æ‰©å±• (ä¿®æ”¹ skyvern/webeye/browser_manager.py) =====
# åœ¨_create_browser_stateæ–¹æ³•ä¸­æ·»åŠ browser_configæ”¯æŒï¼š
 
@staticmethod
async def _create_browser_state(
    proxy_location: ProxyLocation | None = None,
    url: str | None = None,
    task_id: str | None = None,
    workflow_run_id: str | None = None,
    script_id: str | None = None,
    organization_id: str | None = None,
    extra_http_headers: dict[str, str] | None = None,
    browser_address: str | None = None,
    browser_config: BrowserConfig | None = None,  # æ–°å¢å‚æ•°
) -> BrowserState:
    """
    åˆ›å»ºæµè§ˆå™¨çŠ¶æ€å®ä¾‹ï¼Œæ”¯æŒå¤šç§æµè§ˆå™¨ç±»å‹
    
    Args:
        browser_config: æµè§ˆå™¨é…ç½®ï¼Œå†³å®šä½¿ç”¨å“ªç§æµè§ˆå™¨ç±»å‹
        ... å…¶ä»–ç°æœ‰å‚æ•°ä¿æŒä¸å˜ ...
    """
    pw = await async_playwright().start()
    
    # æ ¹æ®browser_configç¡®å®šæµè§ˆå™¨ç±»å‹
    if browser_config:
        if browser_config.type == BrowserType.ADSPOWER:
            browser_type = "adspower"
        elif browser_config.type == BrowserType.LOCAL_CUSTOM:
            browser_type = "local-custom"
        else:
            # SKYVERN_DEFAULT ä½¿ç”¨ç°æœ‰é€»è¾‘
            browser_type = "chromium-headful" if SettingsManager.get_settings().BROWSER_TYPE == "headed" else "chromium-headless"
    else:
        # ä¿æŒå‘åå…¼å®¹ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
        browser_type = "chromium-headful" if SettingsManager.get_settings().BROWSER_TYPE == "headed" else "chromium-headless"
    
    # ä¼ é€’browser_configåˆ°browser factory
    kwargs = {
        "proxy_location": proxy_location,
        "extra_http_headers": extra_http_headers,
        "browser_address": browser_address,
        "browser_config": browser_config,  # ä¼ é€’é…ç½®
    }
    
    browser_context, browser_artifacts, browser_cleanup = await BrowserContextFactory.create_browser_context(
        pw, browser_type=browser_type, **kwargs
    )
    
    return BrowserState(
        pw,
        browser_context,
        browser_artifacts=browser_artifacts,
        browser_cleanup=browser_cleanup,
    )
 
# ä¿®æ”¹get_or_create_for_taskæ–¹æ³•ä»¥æ”¯æŒbrowser_configï¼š
async def get_or_create_for_task(
    self,
    task: Task,
    browser_session_id: str | None = None,
) -> BrowserState:
    """
    ä¸ºä»»åŠ¡è·å–æˆ–åˆ›å»ºæµè§ˆå™¨çŠ¶æ€ï¼Œæ”¯æŒbrowser_config
    """
    # ... ç°æœ‰é€»è¾‘ä¿æŒä¸å˜ï¼Œç›´åˆ°åˆ›å»ºæ–°æµè§ˆå™¨çŠ¶æ€çš„éƒ¨åˆ† ...
    
    # åœ¨åˆ›å»ºæ–°æµè§ˆå™¨çŠ¶æ€æ—¶ä¼ é€’browser_config
    browser_state = await self._create_browser_state(
        proxy_location=task.proxy_location,
        url=task.url,
        task_id=task.task_id,
        workflow_run_id=task.workflow_run_id,
        organization_id=task.organization_id,
        extra_http_headers=task.extra_http_headers,
        browser_address=task.browser_address,
        browser_config=task.browser_config,  # ä¼ é€’æµè§ˆå™¨é…ç½®
    )
    
    # ... å…¶ä½™é€»è¾‘ä¿æŒä¸å˜ ...
 
# ===== 5. APIè·¯ç”±æ‰©å±• (æ–°å»º skyvern/forge/sdk/routes/browser.py) =====
from fastapi import APIRouter, HTTPException, Depends
from skyvern.forge.sdk.schemas.browser import AdsPowerStatus, BrowserConfig
from skyvern.webeye.browser_factory import AdsPowerService
from skyvern.forge.sdk.api.models import validate_api_key
 
router = APIRouter()
 
@router.get("/adspower/status", response_model=AdsPowerStatus)
async def get_adspower_status(
    api_key: str = Depends(validate_api_key)
) -> AdsPowerStatus:
    """
    è·å–AdsPoweræœåŠ¡çŠ¶æ€å’Œå¯ç”¨æµè§ˆå™¨åˆ—è¡¨
    
    æ£€æŸ¥AdsPowerå®¢æˆ·ç«¯æ˜¯å¦è¿è¡Œï¼Œå¹¶è¿”å›å¯ç”¨çš„æµè§ˆå™¨é…ç½®åˆ—è¡¨
    ç”¨äºå‰ç«¯æ˜¾ç¤ºå¯é€‰çš„é˜²å…³è”æµè§ˆå™¨
    
    Returns:
        AdsPowerStatus: åŒ…å«æœåŠ¡çŠ¶æ€å’Œæµè§ˆå™¨åˆ—è¡¨
    """
    try:
        adspower_service = AdsPowerService()
        status = await adspower_service.check_status()
        return status
    except Exception as e:
        LOG.error("è·å–AdsPowerçŠ¶æ€å¤±è´¥", error=str(e))
        raise HTTPException(status_code=500, detail=f"è·å–AdsPowerçŠ¶æ€å¤±è´¥: {str(e)}")
 
@router.post("/validate-chrome-path")
async def validate_chrome_path(
    chrome_path: str,
    api_key: str = Depends(validate_api_key)
) -> dict:
    """
    éªŒè¯Chromeè·¯å¾„æ˜¯å¦æœ‰æ•ˆ
    
    Args:
        chrome_path: Chromeæ‰§è¡Œæ–‡ä»¶è·¯å¾„
        
    Returns:
        dict: åŒ…å«éªŒè¯ç»“æœçš„å­—å…¸
    """
    try:
        path = Path(chrome_path)
        is_valid = path.exists() and path.is_file()
        
        return {
            "valid": is_valid,
            "message": "Chromeè·¯å¾„æœ‰æ•ˆ" if is_valid else "Chromeè·¯å¾„æ— æ•ˆæˆ–æ–‡ä»¶ä¸å­˜åœ¨",
            "path": str(path.absolute()) if is_valid else None
        }
    except Exception as e:
        return {
            "valid": False,
            "message": f"è·¯å¾„éªŒè¯å¤±è´¥: {str(e)}",
            "path": None
        }
 
# ===== 6. å‰ç«¯ç±»å‹å®šä¹‰ (skyvern-frontend/src/api/types.ts) =====
// åœ¨ç°æœ‰types.tsæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ç±»å‹å®šä¹‰ï¼š
 
export enum BrowserType {
  SkyvernDefault = "skyvern_default",
  LocalCustom = "local_custom", 
  AdsPower = "adspower"
}
 
export interface BrowserConfig {
  type: BrowserType;
  chrome_path?: string;
  chrome_args?: string[];
  adspower_user_id?: string;
  adspower_group_id?: string;
}
 
export interface AdsPowerBrowserInfo {
  user_id: string;
  name: string;
  serial_number: string;
  remark?: string;
  group_id?: string;
  status: string;
}
 
export interface AdsPowerStatus {
  available: boolean;
  message: string;
  browsers: AdsPowerBrowserInfo[];
}
 
// æ‰©å±•CreateTaskRequestæ¥å£
export interface CreateTaskRequest {
  // ... ç°æœ‰å­—æ®µä¿æŒä¸å˜ ...
  browser_config?: BrowserConfig;
}
 
// ===== 7. å‰ç«¯APIå®¢æˆ·ç«¯ (skyvern-frontend/src/api/AxiosClient.ts) =====
// åœ¨ç°æœ‰AxiosClientä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š
 
export const getAdsPowerStatus = async (): Promise<AdsPowerStatus> => {
  const response = await client.get<AdsPowerStatus>('/browser/adspower/status');
  return response.data;
};
 
export const validateChromePath = async (chromePath: string): Promise<{valid: boolean; message: string; path?: string}> => {
  const response = await client.post('/browser/validate-chrome-path', { chrome_path: chromePath });
  return response.data;
};
 
// ===== 8. å‰ç«¯æµè§ˆå™¨é€‰æ‹©å™¨ç»„ä»¶ (skyvern-frontend/src/components/BrowserSelector.tsx) =====
import React, { useState, useEffect } from 'react';
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { Control, useWatch } from 'react-hook-form';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "./ui/select";
import { Input } from "./ui/input";
import { Button } from "./ui/button";
import { Alert, AlertDescription } from "./ui/alert";
import { FormField, FormItem, FormLabel, FormControl, FormMessage, FormDescription } from "./ui/form";
import { RefreshCw, ExternalLink, CheckCircle, XCircle, Chrome, Shield, Zap } from "lucide-react";
import { BrowserType, BrowserConfig, AdsPowerStatus } from "../api/types";
import { getAdsPowerStatus, validateChromePath } from "../api/AxiosClient";
 
interface BrowserSelectorProps {
  control: Control<any>;
  name?: string;
}
 
export function BrowserSelector({ control, name = "browser_config" }: BrowserSelectorProps) {
  const queryClient = useQueryClient();
  
  // ç›‘å¬è¡¨å•å­—æ®µå˜åŒ–
  const watchedConfig = useWatch({
    control,
    name,
    defaultValue: { type: BrowserType.SkyvernDefault }
  }) as BrowserConfig;
 
  const browserType = watchedConfig?.type || BrowserType.SkyvernDefault;
  const chromePath = watchedConfig?.chrome_path || "";
  const adsPowerUserId = watchedConfig?.adspower_user_id || "";
 
  // AdsPowerçŠ¶æ€æŸ¥è¯¢
  const { 
    data: adsPowerStatus, 
    isLoading: isCheckingAdsPower, 
    refetch: refetchAdsPower 
  } = useQuery({
    queryKey: ["adspower-status"],
    queryFn: getAdsPowerStatus,
    enabled: browserType === BrowserType.AdsPower,
    refetchInterval: 15000, // 15ç§’è‡ªåŠ¨åˆ·æ–°
    staleTime: 10000,
    retry: 1
  });
 
  // Chromeè·¯å¾„éªŒè¯æŸ¥è¯¢
  const { 
    data: chromeValidation,
    isLoading: isValidatingChrome 
  } = useQuery({
    queryKey: ["chrome-path-validation", chromePath],
    queryFn: () => validateChromePath(chromePath),
    enabled: browserType === BrowserType.LocalCustom && chromePath.length > 5,
    staleTime: 30000
  });
 
  // æ‰“å¼€AdsPowerå®¢æˆ·ç«¯
  const openAdsPowerClient = () => {
    try {
      // å°è¯•ä½¿ç”¨è‡ªå®šä¹‰åè®®æ‰“å¼€
      window.open('adspower://', '_blank');
    } catch {
      // é™çº§åˆ°å®˜ç½‘ä¸‹è½½é¡µé¢
      window.open('https://www.adspower.com/download', '_blank');
    }
  };
 
  // æµè§ˆå™¨ç±»å‹é€‰é¡¹é…ç½®
  const browserTypeOptions = [
    {
      value: BrowserType.SkyvernDefault,
      label: "ğŸ¤– Skyverné»˜è®¤æµè§ˆå™¨",
      description: "æ¨èé€‰é¡¹ï¼Œç¨³å®šå¯é ï¼Œè‡ªåŠ¨ç®¡ç†",
      icon: <Zap className="w-4 h-4" />
    },
    {
      value: BrowserType.LocalCustom,
      label: "ğŸŒ æœ¬åœ°è‡ªå®šä¹‰Chrome",
      description: "ä½¿ç”¨æœ¬åœ°Chromeï¼Œæ”¯æŒå¤§çª—å£å’Œè‡ªå®šä¹‰å‚æ•°",
      icon: <Chrome className="w-4 h-4" />
    },
    {
      value: BrowserType.AdsPower,
      label: "ğŸ›¡ï¸ AdsPoweré˜²å…³è”æµè§ˆå™¨",
      description: "ä¼ä¸šçº§åæ£€æµ‹ï¼Œé€‚åˆæ•æ„Ÿä¸šåŠ¡åœºæ™¯",
      icon: <Shield className="w-4 h-4" />
    }
  ];
 
  return (
    <div className="space-y-6">
      {/* æµè§ˆå™¨ç±»å‹é€‰æ‹© */}
      <FormField
        control={control}
        name={`${name}.type`}
        render={({ field }) => (
          <FormItem>
            <FormLabel>
              <div className="flex flex-col space-y-1">
                <h3 className="text-lg font-medium">æµè§ˆå™¨ç±»å‹</h3>
                <p className="text-sm text-muted-foreground">
                  é€‰æ‹©ä»»åŠ¡æ‰§è¡Œæ—¶ä½¿ç”¨çš„æµè§ˆå™¨ç¯å¢ƒ
                </p>
              </div>
            </FormLabel>
            <FormControl>
              <Select value={field.value} onValueChange={field.onChange}>
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="é€‰æ‹©æµè§ˆå™¨ç±»å‹" />
                </SelectTrigger>
                <SelectContent>
                  {browserTypeOptions.map((option) => (
                    <SelectItem key={option.value} value={option.value}>
                      <div className="flex items-start space-x-3 py-2">
                        {option.icon}
                        <div className="flex flex-col">
                          <span className="font-medium">{option.label}</span>
                          <span className="text-xs text-muted-foreground">
                            {option.description}
                          </span>
                        </div>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </FormControl>
            <FormMessage />
          </FormItem>
        )}
      />
 
      {/* æœ¬åœ°Chromeé…ç½®é¢æ¿ */}
      {browserType === BrowserType.LocalCustom && (
        <div className="border rounded-lg p-4 bg-blue-50/50 space-y-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <Chrome className="w-5 h-5 text-blue-600" />
              <h4 className="text-lg font-medium">æœ¬åœ°Chromeé…ç½®</h4>
            </div>
            {chromeValidation && (
              <div className="flex items-center space-x-1">
                {chromeValidation.valid ? (
                  <>
                    <CheckCircle className="w-4 h-4 text-green-500" />
                    <span className="text-sm text-green-600">è·¯å¾„æœ‰æ•ˆ</span>
                  </>
                ) : (
                  <>
                    <XCircle className="w-4 h-4 text-red-500" />
                    <span className="text-sm text-red-600">è·¯å¾„æ— æ•ˆ</span>
                  </>
                )}
              </div>
            )}
          </div>
 
          <FormField
            control={control}
            name={`${name}.chrome_path`}
            render={({ field }) => (
              <FormItem>
                <FormLabel>Chromeæ‰§è¡Œæ–‡ä»¶è·¯å¾„ *</FormLabel>
                <FormControl>
                  <Input
                    {...field}
                    placeholder="C:\Program Files\Google\Chrome\Application\chrome.exe"
                    className={chromeValidation?.valid === false ? "border-red-300" : ""}
                  />
                </FormControl>
                <FormDescription>
                  <div className="text-sm space-y-1">
                    <p>å¸¸è§è·¯å¾„å‚è€ƒï¼š</p>
                    <ul className="list-disc list-inside space-y-0.5 text-xs">
                      <li><strong>Windows:</strong> C:\Program Files\Google\Chrome\Application\chrome.exe</li>
                      <li><strong>macOS:</strong> /Applications/Google Chrome.app/Contents/MacOS/Google Chrome</li>
                      <li><strong>Linux:</strong> /usr/bin/google-chrome</li>
                    </ul>
                  </div>
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
 
          <FormField
            control={control}
            name={`${name}.chrome_args`}
            render={({ field }) => (
              <FormItem>
                <FormLabel>Chromeå¯åŠ¨å‚æ•°ï¼ˆå¯é€‰ï¼‰</FormLabel>
                <FormControl>
                  <Input
                    {...field}
                    value={Array.isArray(field.value) ? field.value.join(' ') : field.value || ''}
                    onChange={(e) => {
                      const args = e.target.value ? e.target.value.split(' ').filter(Boolean) : [];
                      field.onChange(args);
                    }}
                    placeholder="--window-size=1920,1080 --start-maximized"
                  />
                </FormControl>
                <FormDescription>
                  ç”¨ç©ºæ ¼åˆ†éš”å¤šä¸ªå‚æ•°ï¼Œä¾‹å¦‚: --window-size=1920,1080 --start-maximized
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>
      )}
 
      {/* AdsPoweré…ç½®é¢æ¿ */}
      {browserType === BrowserType.AdsPower && (
        <div className="border rounded-lg p-4 bg-green-50/50 space-y-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <Shield className="w-5 h-5 text-green-600" />
              <h4 className="text-lg font-medium">AdsPoweré˜²å…³è”æµè§ˆå™¨</h4>
            </div>
            <div className="flex items-center space-x-2">
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => refetchAdsPower()}
                disabled={isCheckingAdsPower}
              >
                <RefreshCw className={`w-4 h-4 mr-1 ${isCheckingAdsPower ? 'animate-spin' : ''}`} />
                åˆ·æ–°
              </Button>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={openAdsPowerClient}
              >
                <ExternalLink className="w-4 h-4 mr-1" />
                æ‰“å¼€AdsPower
              </Button>
            </div>
          </div>
 
          {/* AdsPoweræœåŠ¡çŠ¶æ€ */}
          {adsPowerStatus && (
            <Alert className={`${
              adsPowerStatus.available 
                ? 'border-green-200 bg-green-50' 
                : 'border-red-200 bg-red-50'
            }`}>
              <div className="flex items-start space-x-2">
                {adsPowerStatus.available ? (
                  <CheckCircle className="w-4 h-4 text-green-500 mt-0.5" />
                ) : (
                  <XCircle className="w-4 h-4 text-red-500 mt-0.5" />
                )}
                <div className="flex-1">
                  <AlertDescription className={
                    adsPowerStatus.available ? 'text-green-700' : 'text-red-700'
                  }>
                    {adsPowerStatus.message}
                    {!adsPowerStatus.available && (
                      <div className="text-sm mt-2 space-y-1">
                        <p>è¯·ç¡®ä¿ï¼š</p>
                        <ul className="list-disc list-inside text-xs space-y-0.5">
                          <li>AdsPowerå®¢æˆ·ç«¯å·²å¯åŠ¨å¹¶ç™»å½•</li>
                          <li>APIæ¥å£ç«¯å£50325æœªè¢«å ç”¨</li>
                          <li>é˜²ç«å¢™å…è®¸æœ¬åœ°è¿æ¥</li>
                        </ul>
                      </div>
                    )}
                  </AlertDescription>
                </div>
              </div>
            </Alert>
          )}
 
          {/* æµè§ˆå™¨é€‰æ‹© */}
          {isCheckingAdsPower ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
              <p className="text-sm text-muted-foreground mt-3">æ­£åœ¨æ£€æµ‹AdsPowerè¿æ¥çŠ¶æ€...</p>
            </div>
          ) : adsPowerStatus?.available ? (
            <FormField
              control={control}
              name={`${name}.adspower_user_id`}
              render={({ field }) => (
                <FormItem>
                  <FormLabel>é€‰æ‹©AdsPoweræµè§ˆå™¨ *</FormLabel>
                  <FormControl>
                    <Select value={field.value} onValueChange={field.onChange}>
                      <SelectTrigger>
                        <SelectValue 
                          placeholder={
                            adsPowerStatus.browsers?.length === 0 
                              ? "æœªæ‰¾åˆ°å¯ç”¨æµè§ˆå™¨ï¼Œè¯·å…ˆåœ¨AdsPowerä¸­åˆ›å»º" 
                              : "é€‰æ‹©ä¸€ä¸ªæµè§ˆå™¨é…ç½®"
                          } 
                        />
                      </SelectTrigger>
                      <SelectContent>
                        {adsPowerStatus.browsers?.map((browser) => (
                          <SelectItem key={browser.user_id} value={browser.user_id}>
                            <div className="flex flex-col py-1">
                              <div className="flex items-center space-x-2">
                                <Shield className="w-3 h-3 text-green-500" />
                                <span className="font-medium">{browser.name}</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                  browser.status === 'Active' 
                                    ? 'bg-green-100 text-green-700' 
                                    : 'bg-gray-100 text-gray-600'
                                }`}>
                                  {browser.status}
                                </span>
                              </div>
                              <div className="text-xs text-muted-foreground mt-1">
                                ID: {browser.user_id} | åºåˆ—å·: {browser.serial_number}
                                {browser.remark && ` | ${browser.remark}`}
                              </div>
                            </div>
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </FormControl>
                  <FormDescription>
                    {adsPowerStatus.browsers?.length === 0 ? (
                      <span className="text-amber-600">
                        è¯·å…ˆåœ¨AdsPowerå®¢æˆ·ç«¯ä¸­åˆ›å»ºæµè§ˆå™¨é…ç½®
                      </span>
                    ) : (
                      `æ‰¾åˆ° ${adsPowerStatus.browsers?.length} ä¸ªå¯ç”¨æµè§ˆå™¨é…ç½®`
                    )}
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          ) : (
            <div className="text-center py-8">
              <Shield className="w-12 h-12 text-gray-400 mx-auto mb-4" />
              <p className="text-muted-foreground">è¯·å¯åŠ¨AdsPowerå®¢æˆ·ç«¯åé‡è¯•</p>
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={openAdsPowerClient}
                className="mt-3"
              >
                <ExternalLink className="w-4 h-4 mr-1" />
                ä¸‹è½½AdsPower
              </Button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
 
// ===== 9. ä»»åŠ¡åˆ›å»ºè¡¨å•é›†æˆç¤ºä¾‹ =====
// åœ¨ä»»åŠ¡åˆ›å»ºè¡¨å•ä¸­ä½¿ç”¨BrowserSelectorç»„ä»¶ï¼š
 
import { BrowserSelector } from '../components/BrowserSelector';
import { BrowserType } from '../api/types';
 
// åœ¨è¡¨å•schemaä¸­æ·»åŠ browser_configå­—æ®µï¼š
const taskFormSchema = z.object({
  // ... ç°æœ‰å­—æ®µ ...
  browser_config: z.object({
    type: z.nativeEnum(BrowserType).default(BrowserType.SkyvernDefault),
    chrome_path: z.string().optional(),
    chrome_args: z.array(z.string()).optional(),
    adspower_user_id: z.string().optional(),
    adspower_group_id: z.string().optional(),
  }).optional(),
});
 
// åœ¨è¡¨å•ç»„ä»¶ä¸­ï¼š
function TaskCreateForm() {
  const form = useForm({
    resolver: zodResolver(taskFormSchema),
    defaultValues: {
      // ... ç°æœ‰é»˜è®¤å€¼ ...
      browser_config: {
        type: BrowserType.SkyvernDefault
      }
    }
  });
 
  return (
    <Form {...form}>
      {/* ... å…¶ä»–è¡¨å•å­—æ®µ ... */}
      
      <BrowserSelector control={form.control} name="browser_config" />
      
      {/* ... æäº¤æŒ‰é’®ç­‰ ... */}
    </Form>
  );
}