# 步骤8: 任务创建表单集成

## 概述
将浏览器选择器组件集成到任务创建表单中，实现完整的用户工作流。

## 目标文件
任务创建相关组件文件

## 实施内容

### 8.1 创建任务表单Schema定义
```typescript
// skyvern-frontend/src/schemas/taskSchema.ts
import { z } from 'zod';
import { BrowserType } from '../api/types';

// 浏览器配置Schema
export const browserConfigSchema = z.object({
  type: z.nativeEnum(BrowserType).default(BrowserType.SkyvernDefault),
  chrome_path: z.string().optional(),
  chrome_args: z.array(z.string()).optional(),
  adspower_user_id: z.string().optional(),
  adspower_group_id: z.string().optional()
}).refine((data) => {
  // 条件验证：本地Chrome模式需要chrome_path
  if (data.type === BrowserType.LocalCustom) {
    return data.chrome_path && data.chrome_path.trim().length > 0;
  }
  return true;
}, {
  message: "本地Chrome模式需要提供Chrome执行文件路径",
  path: ["chrome_path"]
}).refine((data) => {
  // 条件验证：AdsPower模式需要adspower_user_id
  if (data.type === BrowserType.AdsPower) {
    return data.adspower_user_id && data.adspower_user_id.trim().length > 0;
  }
  return true;
}, {
  message: "AdsPower模式需要选择浏览器配置",
  path: ["adspower_user_id"]
});

// 完整的任务创建Schema
export const createTaskSchema = z.object({
  // 基本任务信息
  url: z.string().url("请输入有效的URL"),
  navigation_goal: z.string().optional(),
  data_extraction_goal: z.string().optional(),
  navigation_payload: z.record(z.unknown()).optional(),
  extracted_information_schema: z.record(z.unknown()).optional(),

  // 高级选项
  webhook_callback_url: z.string().url("请输入有效的Webhook URL").optional().or(z.literal("")),
  totp_verification_url: z.string().url("请输入有效的TOTP验证URL").optional().or(z.literal("")),
  totp_identifier: z.string().optional(),
  proxy_location: z.enum(['US', 'EU', 'AP']).optional(),

  // 浏览器配置
  browser_config: browserConfigSchema.optional(),

  // 任务设置
  max_steps: z.number().min(1).max(100).default(10),
  max_retries: z.number().min(0).max(5).default(3),
  timeout: z.number().min(30).max(3600).default(300)
});

export type CreateTaskFormData = z.infer<typeof createTaskSchema>;
```

### 8.2 任务创建表单组件
```typescript
// skyvern-frontend/src/routes/tasks/create/TaskCreateForm.tsx
import React, { useState, useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Form } from '@/components/ui/form';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Info, Save, Play, Settings, Globe, Shield, Chrome } from 'lucide-react';

import { createTaskSchema, CreateTaskFormData } from '@/schemas/taskSchema';
import { BrowserSelector } from '@/components/BrowserSelector';
import { BasicInfoSection } from './sections/BasicInfoSection';
import { AdvancedOptionsSection } from './sections/AdvancedOptionsSection';
import { TaskSettingsSection } from './sections/TaskSettingsSection';

interface TaskCreateFormProps {
  onSubmit: (data: CreateTaskFormData) => Promise<void>;
  isSubmitting?: boolean;
  initialValues?: Partial<CreateTaskFormData>;
}

export function TaskCreateForm({
  onSubmit,
  isSubmitting = false,
  initialValues
}: TaskCreateFormProps) {
  const [activeTab, setActiveTab] = useState('basic');
  const [showBrowserConfig, setShowBrowserConfig] = useState(false);

  const form = useForm<CreateTaskFormData>({
    resolver: zodResolver(createTaskSchema),
    defaultValues: {
      url: '',
      navigation_goal: '',
      data_extraction_goal: '',
      max_steps: 10,
      max_retries: 3,
      timeout: 300,
      browser_config: {
        type: BrowserType.SkyvernDefault
      },
      ...initialValues
    }
  });

  const { watch, formState: { errors } } = form;
  const watchedBrowserConfig = watch('browser_config');

  // 监听浏览器配置变化
  useEffect(() => {
    console.log('浏览器配置更新:', watchedBrowserConfig);
  }, [watchedBrowserConfig]);

  const handleSubmit = async (data: CreateTaskFormData) => {
    try {
      await onSubmit(data);
    } catch (error) {
      console.error('任务创建失败:', error);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* 主要配置区域 */}
          <div className="lg:col-span-2 space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Globe className="w-5 h-5" />
                  <span>基本任务信息</span>
                </CardTitle>
                <CardDescription>
                  设置任务的URL、目标和导航参数
                </CardDescription>
              </CardHeader>
              <CardContent>
                <Tabs value={activeTab} onValueChange={setActiveTab}>
                  <TabsList className="grid w-full grid-cols-3">
                    <TabsTrigger value="basic">基本信息</TabsTrigger>
                    <TabsTrigger value="advanced">高级选项</TabsTrigger>
                    <TabsTrigger value="settings">任务设置</TabsTrigger>
                  </TabsList>

                  <TabsContent value="basic" className="space-y-4">
                    <BasicInfoSection />
                  </TabsContent>

                  <TabsContent value="advanced" className="space-y-4">
                    <AdvancedOptionsSection />
                  </TabsContent>

                  <TabsContent value="settings" className="space-y-4">
                    <TaskSettingsSection />
                  </TabsContent>
                </Tabs>
              </CardContent>
            </Card>

            {/* 浏览器配置部分 */}
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <Shield className="w-5 h-5" />
                    <CardTitle>浏览器配置</CardTitle>
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setShowBrowserConfig(!showBrowserConfig)}
                  >
                    {showBrowserConfig ? '隐藏' : '显示'}配置
                  </Button>
                </div>
                <CardDescription>
                  选择任务执行时使用的浏览器环境（可选，默认使用Skyvern浏览器）
                </CardDescription>
              </CardHeader>

              {showBrowserConfig && (
                <CardContent>
                  <BrowserSelector control={form.control} name="browser_config" />
                </CardContent>
              )}
            </Card>
          </div>

          {/* 侧边栏 - 预览和快速操作 */}
          <div className="space-y-6">
            {/* 任务预览卡片 */}
            <TaskPreviewCard formData={watch()} />

            {/* 浏览器预览卡片 */}
            <BrowserPreviewCard browserConfig={watchedBrowserConfig} />

            {/* 快速操作 */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Settings className="w-5 h-5" />
                  <span>快速操作</span>
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <Button
                  type="submit"
                  className="w-full"
                  disabled={isSubmitting}
                >
                  {isSubmitting ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      创建中...
                    </>
                  ) : (
                    <>
                      <Play className="w-4 h-4 mr-2" />
                      创建任务
                    </>
                  )}
                </Button>

                <Button
                  type="button"
                  variant="outline"
                  className="w-full"
                  onClick={() => form.reset()}
                >
                  重置表单
                </Button>

                <Button
                  type="button"
                  variant="outline"
                  className="w-full"
                  onClick={() => {
                    // 保存为模板
                    const templateData = form.getValues();
                    localStorage.setItem('task_template', JSON.stringify(templateData));
                    alert('任务配置已保存为模板');
                  }}
                >
                  <Save className="w-4 h-4 mr-2" />
                  保存模板
                </Button>
              </CardContent>
            </Card>

            {/* 配置说明 */}
            <Alert>
              <Info className="w-4 h-4" />
              <AlertDescription>
                <div className="text-sm space-y-1">
                  <p><strong>Skyvern默认浏览器：</strong>推荐选项，无需配置，自动管理</p>
                  <p><strong>本地自定义Chrome：</strong>使用本地Chrome，支持自定义参数</p>
                  <p><strong>AdsPower防关联浏览器：</strong>企业级反检测解决方案</p>
                </div>
              </AlertDescription>
            </Alert>
          </div>
        </div>

        {/* 错误汇总显示 */}
        {Object.keys(errors).length > 0 && (
          <Alert variant="destructive">
            <AlertTriangle className="w-4 h-4" />
            <AlertDescription>
              <div className="text-sm space-y-1">
                <p className="font-medium">表单验证失败，请检查以下项目：</p>
                <ul className="list-disc list-inside">
                  {Object.entries(errors).map(([field, error]) => (
                    <li key={field}>
                      {getFieldLabel(field)}: {error.message}
                    </li>
                  ))}
                </ul>
              </div>
            </AlertDescription>
          </Alert>
        )}
      </form>
    </Form>
  );
}
```

### 8.3 任务预览卡片组件
```typescript
// skyvern-frontend/src/routes/tasks/create/TaskPreviewCard.tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Globe, Clock, Target, Database } from 'lucide-react';
import { CreateTaskFormData } from '@/schemas/taskSchema';

interface TaskPreviewCardProps {
  formData: CreateTaskFormData;
}

export function TaskPreviewCard({ formData }: TaskPreviewCardProps) {
  const getGoalSummary = () => {
    const goals = [];
    if (formData.navigation_goal) goals.push('导航');
    if (formData.data_extraction_goal) goals.push('数据提取');
    return goals.length > 0 ? goals.join(' + ') : '无明确目标';
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base">任务预览</CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="space-y-2">
          <div className="flex items-center space-x-2 text-sm">
            <Globe className="w-4 h-4 text-muted-foreground" />
            <span className="text-muted-foreground">URL:</span>
            <span className="truncate font-mono text-xs">
              {formData.url || '未设置'}
            </span>
          </div>

          <div className="flex items-center space-x-2 text-sm">
            <Target className="w-4 h-4 text-muted-foreground" />
            <span className="text-muted-foreground">目标:</span>
            <Badge variant="outline" className="text-xs">
              {getGoalSummary()}
            </Badge>
          </div>

          <div className="flex items-center space-x-2 text-sm">
            <Clock className="w-4 h-4 text-muted-foreground" />
            <span className="text-muted-foreground">超时:</span>
            <span>{formData.timeout}秒</span>
          </div>

          <div className="flex items-center space-x-2 text-sm">
            <Database className="w-4 h-4 text-muted-foreground" />
            <span className="text-muted-foreground">最大步骤:</span>
            <span>{formData.max_steps}</span>
          </div>
        </div>

        {formData.navigation_goal && (
          <div className="mt-3 p-2 bg-muted rounded text-xs">
            <p className="font-medium text-muted-foreground mb-1">导航目标:</p>
            <p className="line-clamp-3">{formData.navigation_goal}</p>
          </div>
        )}

        {formData.data_extraction_goal && (
          <div className="mt-3 p-2 bg-muted rounded text-xs">
            <p className="font-medium text-muted-foreground mb-1">数据提取目标:</p>
            <p className="line-clamp-3">{formData.data_extraction_goal}</p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

### 8.4 浏览器预览卡片组件
```typescript
// skyvern-frontend/src/routes/tasks/create/BrowserPreviewCard.tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Shield, Chrome, Zap, AlertTriangle, CheckCircle } from 'lucide-react';
import { BrowserConfig, BrowserType } from '@/api/types';

interface BrowserPreviewCardProps {
  browserConfig?: BrowserConfig;
}

export function BrowserPreviewCard({ browserConfig }: BrowserPreviewCardProps) {
  if (!browserConfig) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-base flex items-center space-x-2">
            <Zap className="w-4 h-4" />
            <span>浏览器配置</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-center py-4">
            <Zap className="w-8 h-8 text-muted-foreground mx-auto mb-2" />
            <p className="text-sm text-muted-foreground">使用Skyvern默认浏览器</p>
            <Badge variant="secondary" className="mt-2">推荐配置</Badge>
          </div>
        </CardContent>
      </Card>
    );
  }

  const getBrowserIcon = () => {
    switch (browserConfig.type) {
      case BrowserType.LocalCustom:
        return <Chrome className="w-4 h-4" />;
      case BrowserType.AdsPower:
        return <Shield className="w-4 h-4" />;
      default:
        return <Zap className="w-4 h-4" />;
    }
  };

  const getBrowserLabel = () => {
    switch (browserConfig.type) {
      case BrowserType.LocalCustom:
        return '本地自定义Chrome';
      case BrowserType.AdsPower:
        return 'AdsPower防关联浏览器';
      default:
        return 'Skyvern默认浏览器';
    }
  };

  const getStatusIcon = () => {
    if (browserConfig.type === BrowserType.LocalCustom) {
      return browserConfig.chrome_path ? (
        <CheckCircle className="w-4 h-4 text-green-500" />
      ) : (
        <AlertTriangle className="w-4 h-4 text-yellow-500" />
      );
    }

    if (browserConfig.type === BrowserType.AdsPower) {
      return browserConfig.adspower_user_id ? (
        <CheckCircle className="w-4 h-4 text-green-500" />
      ) : (
        <AlertTriangle className="w-4 h-4 text-yellow-500" />
      );
    }

    return <CheckCircle className="w-4 h-4 text-green-500" />;
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base flex items-center space-x-2">
          {getBrowserIcon()}
          <span>浏览器配置</span>
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-2">
            <Badge variant="outline">{getBrowserLabel()}</Badge>
          </div>
          {getStatusIcon()}
        </div>

        {browserConfig.type === BrowserType.LocalCustom && browserConfig.chrome_path && (
          <div className="text-sm space-y-1">
            <p className="text-muted-foreground">Chrome路径:</p>
            <p className="text-xs font-mono bg-muted p-2 rounded truncate">
              {browserConfig.chrome_path}
            </p>
            {browserConfig.chrome_args && browserConfig.chrome_args.length > 0 && (
              <div className="mt-2">
                <p className="text-muted-foreground">启动参数:</p>
                <div className="flex flex-wrap gap-1 mt-1">
                  {browserConfig.chrome_args.map((arg, index) => (
                    <code key={index} className="text-xs bg-muted px-1 py-0.5 rounded">
                      {arg}
                    </code>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {browserConfig.type === BrowserType.AdsPower && browserConfig.adspower_user_id && (
          <div className="text-sm space-y-1">
            <p className="text-muted-foreground">用户ID:</p>
            <p className="text-xs font-mono bg-muted p-2 rounded">
              {browserConfig.adspower_user_id}
            </p>
          </div>
        )}

        {browserConfig.type === BrowserType.SkyvernDefault && (
          <div className="text-sm text-muted-foreground">
            <p>使用Skyvern提供的默认浏览器配置</p>
            <p className="text-xs mt-1">✓ 无需额外配置</p>
            <p className="text-xs">✓ 自动管理更新</p>
            <p className="text-xs">✓ 最佳兼容性</p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

### 8.5 表单提交和处理
```typescript
// skyvern-frontend/src/routes/tasks/create/TaskCreatePage.tsx
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useToast } from '@/components/ui/use-toast';
import { TaskCreateForm } from './TaskCreateForm';
import { CreateTaskFormData } from '@/schemas/taskSchema';
import { createTask } from '@/api/tasks';

export function TaskCreatePage() {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (formData: CreateTaskFormData) => {
    setIsSubmitting(true);

    try {
      // 准备任务数据
      const taskData = {
        url: formData.url,
        navigation_goal: formData.navigation_goal,
        data_extraction_goal: formData.data_extraction_goal,
        navigation_payload: formData.navigation_payload,
        extracted_information_schema: formData.extracted_information_schema,
        webhook_callback_url: formData.webhook_callback_url,
        totp_verification_url: formData.totp_verification_url,
        totp_identifier: formData.totp_identifier,
        proxy_location: formData.proxy_location,
        max_steps: formData.max_steps,
        max_retries: formData.max_retries,
        timeout: formData.timeout,
        // 浏览器配置
        browser_config: formData.browser_config
      };

      // 发送创建任务请求
      const response = await createTask(taskData);

      toast({
        title: '任务创建成功',
        description: `任务ID: ${response.task_id}`,
        duration: 5000
      });

      // 跳转到任务详情页
      navigate(`/tasks/${response.task_id}`);

    } catch (error) {
      console.error('任务创建失败:', error);

      toast({
        title: '任务创建失败',
        description: error instanceof Error ? error.message : '未知错误',
        variant: 'destructive',
        duration: 5000
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">创建新任务</h1>
      </div>

      <TaskCreateForm
        onSubmit={handleSubmit}
        isSubmitting={isSubmitting}
      />
    </div>
  );
}
```

### 8.6 表单验证增强
```typescript
// 增强的表单验证和处理
export function EnhancedTaskCreateForm() {
  const form = useForm<CreateTaskFormData>({
    resolver: zodResolver(createTaskSchema),
    mode: 'onChange', // 实时验证
    defaultValues: {
      // ... 默认值
    }
  });

  // 实时验证浏览器配置
  const { watch, trigger, formState: { errors } } = form;
  const browserConfig = watch('browser_config');

  useEffect(() => {
    if (browserConfig) {
      // 触发浏览器配置的实时验证
      trigger('browser_config');
    }
  }, [browserConfig, trigger]);

  // 自定义验证逻辑
  const validateForm = async () => {
    const isValid = await form.trigger();
    if (!isValid) {
      // 滚动到第一个错误字段
      const firstError = Object.keys(errors)[0];
      if (firstError) {
        const element = document.querySelector(`[name="${firstError}"]`);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          element.focus();
        }
      }
      return false;
    }
    return true;
  };

  // 浏览器配置特定的错误处理
  const getBrowserConfigErrors = () => {
    const browserErrors = errors.browser_config;
    if (!browserErrors) return [];

    const errorsList: string[] = [];
    if (browserErrors.type?.message) {
      errorsList.push(`类型: ${browserErrors.type.message}`);
    }
    if (browserErrors.chrome_path?.message) {
      errorsList.push(`Chrome路径: ${browserErrors.chrome_path.message}`);
    }
    if (browserErrors.adspower_user_id?.message) {
      errorsList.push(`AdsPower用户: ${browserErrors.adspower_user_id.message}`);
    }

    return errorsList;
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
        {/* 表单内容 */}

        {/* 浏览器配置错误显示 */}
        {getBrowserConfigErrors().length > 0 && (
          <Alert variant="destructive">
            <AlertTriangle className="w-4 h-4" />
            <AlertDescription>
              <div className="text-sm space-y-1">
                <p className="font-medium">浏览器配置错误：</p>
                <ul className="list-disc list-inside">
                  {getBrowserConfigErrors().map((error, index) => (
                    <li key={index}>{error}</li>
                  ))}
                </ul>
              </div>
            </AlertDescription>
          </Alert>
        )}
      </form>
    </Form>
  );
}
```

## 技术要点

1. **表单验证**: 使用Zod进行运行时验证
2. **条件验证**: 根据浏览器类型进行动态验证
3. **实时反馈**: 实时显示验证错误和建议
4. **用户体验**: 清晰的错误提示和自动聚焦
5. **数据流**: 完整的表单数据处理和提交流程

## 验证方法

1. **表单提交测试**: 验证完整的数据提交流程
2. **验证逻辑测试**: 测试各种验证条件
3. **错误处理测试**: 验证错误提示和恢复
4. **浏览器集成测试**: 测试不同浏览器类型的配置
5. **用户体验测试**: 验证表单的易用性和响应性

## 下一步
完成表单集成后，进入步骤9：测试与部署