# 步骤5: 前端类型定义

## 概述
在TypeScript前端项目中定义浏览器相关的类型接口，确保类型安全和代码提示。

## 目标文件
`skyvern-frontend/src/api/types.ts`

## 实施内容

### 5.1 浏览器类型枚举定义
```typescript
// 浏览器类型枚举，与后端BrowserType保持一致
export enum BrowserType {
  SkyvernDefault = "skyvern_default",
  LocalCustom = "local_custom",
  AdsPower = "adspower"
}
```

### 5.2 浏览器配置接口
```typescript
// 浏览器配置接口，对应后端的BrowserConfig模型
export interface BrowserConfig {
  type: BrowserType;
  chrome_path?: string;
  chrome_args?: string[];
  adspower_user_id?: string;
  adspower_group_id?: string;
}
```

### 5.3 AdsPower浏览器信息接口
```typescript
// AdsPower浏览器信息，对应后端的AdsPowerBrowserInfo模型
export interface AdsPowerBrowserInfo {
  user_id: string;
  name: string;
  serial_number: string;
  remark?: string;
  group_id?: string;
  status: string;
}

// AdsPower服务状态，对应后端的AdsPowerStatus模型
export interface AdsPowerStatus {
  available: boolean;
  message: string;
  browsers: AdsPowerBrowserInfo[];
}
```

### 5.4 Chrome路径验证响应接口
```typescript
// Chrome路径验证响应
export interface ChromePathValidation {
  valid: boolean;
  message: string;
  path?: string;
  file_size_mb?: number;
}

// 详细的Chrome路径验证响应
export interface ChromePathValidationDetailed {
  valid: boolean;
  path: string;
  checks: {
    exists?: boolean;
    is_file?: boolean;
    extension?: boolean;
    file_size?: {
      size_mb: number;
      reasonable: boolean;
    };
    executable_format?: boolean;
  };
  suggestions: string[];
  message: string;
  error?: string;
}
```

### 5.5 浏览器配置建议接口
```typescript
// 浏览器配置建议响应
export interface BrowserConfigSuggestions {
  system: string;
  chrome_paths: {
    Windows: string[];
    Darwin: string[];
    Linux: string[];
  };
  common_args: string[];
  adspower_info: {
    download_url: string;
    api_port: number;
    requirements: string[];
  };
  recommended_paths: string[];
}
```

### 5.6 扩展现有任务相关接口
```typescript
// 扩展创建任务请求接口，添加browser_config字段
export interface CreateTaskRequest {
  // ... 现有字段保持不变 ...
  url: string;
  navigation_goal?: string;
  data_extraction_goal?: string;
  navigation_payload?: Record<string, unknown>;
  extracted_information_schema?: Record<string, unknown>;
  webhook_callback_url?: string;
  totp_verification_url?: string;
  totp_identifier?: string;
  proxy_location?: ProxyLocation;

  // 新增的浏览器配置字段
  browser_config?: BrowserConfig;
}

// 扩展任务响应接口
export interface Task {
  // ... 现有字段保持不变 ...
  task_id: string;
  url: string;
  status: TaskStatus;
  created_at: string;
  modified_at: string;
  organization_id: string;

  // 新增的浏览器配置字段
  browser_config?: BrowserConfig;
}
```

### 5.7 浏览器选择器相关类型
```typescript
// 浏览器类型选项配置
export interface BrowserTypeOption {
  value: BrowserType;
  label: string;
  description: string;
  icon: React.ReactNode;
}

// 浏览器选择器组件属性
export interface BrowserSelectorProps {
  control: Control<any>;
  name?: string;
}

// 浏览器配置表单数据
export interface BrowserConfigFormData {
  browser_config: BrowserConfig;
}
```

### 5.8 API响应统一格式
```typescript
// 统一的API响应格式
export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: unknown;
  };
  timestamp: string;
}

// 分页响应格式
export interface PaginatedResponse<T> {
  items: T[];
  total: number;
  page: number;
  page_size: number;
  has_next: boolean;
  has_prev: boolean;
}
```

### 5.9 完整的类型定义文件
创建完整的类型定义文件：

```typescript
// skyvern-frontend/src/api/browser-types.ts

import { BrowserType } from './types';

// 浏览器相关API路径
export const BROWSER_API_PATHS = {
  adspowerStatus: '/browser/adspower/status',
  validateChromePath: '/browser/validate-chrome-path',
  validateChromePathDetailed: '/browser/validate-chrome-path/detailed',
  browserConfigSuggestions: '/browser/config/suggestions'
} as const;

// 浏览器配置默认值
export const DEFAULT_BROWSER_CONFIG: BrowserConfig = {
  type: BrowserType.SkyvernDefault
};

// Chrome路径默认值（按操作系统）
export const DEFAULT_CHROME_PATHS = {
  Windows: [
    'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
    'C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe'
  ],
  Darwin: [
    '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome'
  ],
  Linux: [
    '/usr/bin/google-chrome',
    '/usr/bin/google-chrome-stable',
    '/usr/bin/chromium'
  ]
};

// 常用Chrome启动参数
export const COMMON_CHROME_ARGS = [
  '--window-size=1920,1080',
  '--start-maximized',
  '--disable-gpu',
  '--no-sandbox',
  '--disable-dev-shm-usage',
  '--disable-blink-features=AutomationControlled',
  '--disable-web-security',
  '--no-first-run',
  '--no-default-browser-check',
  '--disable-infobars',
  '--disable-extensions'
];

// AdsPower状态常量
export const ADSPOWER_STATUS = {
  AVAILABLE: 'available',
  UNAVAILABLE: 'unavailable',
  CONNECTING: 'connecting',
  ERROR: 'error'
} as const;

// 浏览器选择器常量
export const BROWSER_SELECTOR_CONSTANTS = {
  PLACEHOLDERS: {
    chromePath: 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
    chromeArgs: '--window-size=1920,1080 --start-maximized'
  },
  VALIDATION: {
    MIN_PATH_LENGTH: 5,
    MAX_PATH_LENGTH: 500,
    ALLOWED_EXTENSIONS: ['.exe', ''] // Windows允许.exe和无扩展名
  }
} as const;
```

### 5.10 类型工具和辅助函数
```typescript
// 类型守卫函数
export function isBrowserType(value: string): value is BrowserType {
  return Object.values(BrowserType).includes(value as BrowserType);
}

export function isAdsPowerStatus(value: unknown): value is AdsPowerStatus {
  return (
    typeof value === 'object' &&
    value !== null &&
    'available' in value &&
    'message' in value &&
    'browsers' in value
  );
}

// 浏览器配置验证函数
export function validateBrowserConfig(config: BrowserConfig): {
  valid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  // 验证浏览器类型
  if (!config.type || !isBrowserType(config.type)) {
    errors.push('无效的浏览器类型');
  }

  // 验证本地Chrome配置
  if (config.type === BrowserType.LocalCustom) {
    if (!config.chrome_path || config.chrome_path.trim().length < 5) {
      errors.push('本地Chrome模式需要提供有效的chrome路径');
    }
  }

  // 验证AdsPower配置
  if (config.type === BrowserType.AdsPower) {
    if (!config.adspower_user_id || config.adspower_user_id.trim().length === 0) {
      errors.push('AdsPower模式需要提供用户ID');
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

// 获取默认Chrome路径（根据系统）
export function getDefaultChromePaths(): string[] {
  const system = window.navigator.platform.toLowerCase();

  if (system.includes('win')) {
    return DEFAULT_CHROME_PATHS.Windows;
  } else if (system.includes('mac')) {
    return DEFAULT_CHROME_PATHS.Darwin;
  } else {
    return DEFAULT_CHROME_PATHS.Linux;
  }
}
```

## 类型安全最佳实践

### 5.11 严格类型检查
```typescript
// 使用严格的对象类型定义
export type StrictBrowserConfig = {
  type: BrowserType;
  chrome_path?: string;
  chrome_args?: readonly string[]; // 只读数组
  adspower_user_id?: string;
  adspower_group_id?: string;
};

// 使用品牌类型避免字符串混淆
export type UserId = string & { __brand: 'UserId' };
export type ChromePath = string & { __brand: 'ChromePath' };

// 创建品牌类型构造函数
export function createUserId(id: string): UserId {
  if (!id || id.trim().length === 0) {
    throw new Error('Invalid user ID');
  }
  return id as UserId;
}
```

### 5.12 联合类型和字面量类型
```typescript
// 使用字面量类型限定状态值
export type AdsPowerConnectionStatus = 'connected' | 'disconnected' | 'connecting' | 'error';

// 使用联合类型定义浏览器状态
export type BrowserStatus =
  | { type: 'idle' }
  | { type: 'connecting'; browserType: BrowserType }
  | { type: 'connected'; browserType: BrowserType; connectionInfo: unknown }
  | { type: 'error'; error: string };

// 使用模板字面量类型
export type BrowserEventType = `browser:${BrowserType}:${'connected' | 'disconnected' | 'error'}`;
```

## 技术要点

1. **类型一致性**: 与后端模型保持同步
2. **严格类型**: 使用枚举和字面量类型限制取值范围
3. **类型守卫**: 提供运行时类型检查函数
4. **品牌类型**: 避免基本类型的误用
5. **只读属性**: 使用readonly防止意外修改

## 验证方法

1. **类型检查**: 运行TypeScript编译器检查类型错误
2. **接口对齐**: 确保前后端模型字段一致
3. **类型守卫**: 测试类型保护函数的正确性
4. **IDE支持**: 验证代码提示和自动完成功能
5. **运行时验证**: 检查类型转换和验证逻辑

## 下一步
完成前端类型定义后，进入步骤6：前端API客户端